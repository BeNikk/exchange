import express, {type Request, type Response} from "express";
import jwt from 'jsonwebtoken';
import { JWT_SECRET } from '../utils/config.ts';
import { sendEmail } from '../utils/email.ts';
import { Users } from '../shared/users.ts';
const authRouter = express.Router();

authRouter.post("/signup",async(req:Request,res:Response)=>{
  try {
  // const { email }   req.body; IRL email should come by the user, but resend only allows sending email to the user who created the api key
     const email = "bhatt13nikhil@gmail.com"; 
     const token = jwt.sign({email},JWT_SECRET);
     const response = await sendEmail(token);
     if (response == true){
      res.status(200).json({message:"Check your email"});
      return;
      //Users.push({email}); 
      //if we had different users
    }
    else{
    res.status(500).json({message:"Internal server error"});
      return;
    } 
    } catch (error) {
    console.log("ERROR IN SIGNUP",error);
    }
  });

authRoter.post('/signin',(req:Request,res:Response)=>{
  try {
  const email = req.body;
  const user = Users.find((u:any)=>{
    return u.email == email;
  })
  if(!user){
    res.json({message:"User not found, Signup to create the account"});
    return;
  }
  const token = jwt.sign({email},JWT_SECRET);
  const response = await sendEmail(token);
  if(response == true){
    res.status(200).json({message:"Check your email"});
    return;
  }
  else{
    res.status(500).json({message:"Internal server error"});
    return;
  }
  
  } catch (error) {
   console.log("ERROR IN SIGN IN ROUTE");
    res.status(500).json({message:"Internal server error"});
  }
  
})
export default authRouter;
